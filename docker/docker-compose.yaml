name: smart-meal-finder
version: "3"
services:
  # --- BACKEND (New) ---
  spring_app:
    build:
      # GO UP one level to find the backend source code
      context: ../SmartMealFinderB
      # Path is relative to the context above
      dockerfile: docker/Dockerfile
    container_name: smart_meal_finder_backend
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      # Connects to 'app_db' service defined below
      SPRING_DATASOURCE_URL: jdbc:mysql://app_db:3306/Smart_Meal_Finder?allowPublicKeyRetrieval=true&useSSL=false&serverTimezone=UTC
      SPRING_DATASOURCE_USERNAME: app
      SPRING_DATASOURCE_PASSWORD: app_pass@123
      # CORS Config for your WebConfig class
      FRONTEND_URL: http://localhost:3000
      GORSE_ENDPOINT: http://gorse:8088
      #Secrets
      JWT_SECRET: ${JWT_SECRET}
      EMAIL_HOST: ${EMAIL_HOST}
      EMAIL_PORT: ${EMAIL_PORT}
      EMAIL_USERNAME: ${EMAIL_USERNAME}
      EMAIL_PASSWORD: ${EMAIL_PASSWORD}
      GITHUB_ID: ${GITHUB_ID}
      GITHUB_SECRET: ${GITHUB_SECRET}
      GOOGLE_ID: ${GOOGLE_ID}
      GOOGLE_SECRET: ${GOOGLE_SECRET}
      SPOONACULAR_APIKEY: ${SPOONACULAR_APIKEY}
    depends_on:
      - app_db

  # --- FRONTEND (New) ---
  react_app:
    build:
      # GO UP one level to find the frontend source code
      context: ../smart_meal_finderf
      # Path is relative to the context above
      dockerfile: docker/Dockerfile
      args:
        REACT_APP_API_URL: http://localhost:8080
    container_name: smart_meal_finder_frontend
    restart: unless-stopped
    ports:
      - "3000:80"
    depends_on:
      - spring_app

  # --- Application Database ---
  app_db:
    image: mysql/mysql-server
    container_name: smart_meal_finder_db
    restart: unless-stopped
    ports:
      # Mapped to 3307 on host to avoid conflict with Gorse DB (3306)
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root_pass
      MYSQL_DATABASE: Smart_Meal_Finder
      MYSQL_USER: app
      MYSQL_PASSWORD: app_pass@123
    volumes:
      - app_db_data:/var/lib/mysql
  # --- GORSE MASTER & WORKER (All-in-one) ---
  gorse:
    image:
      zhenghaoz/gorse-in-one:0.5
    container_name: gorse_server
    restart: unless-stopped
    ports:
      - "8088:8088"
    environment:
      # Connection with the databases
      # Use Redis as cache storage backend.
      GORSE_CACHE_STORE: redis://gorse_redis:6379
      # Use MySQL as data storage backend.
      GORSE_DATA_STORE: mysql://gorse:gorse_pass@tcp(gorse_db:3306)/gorse?parseTime=true
    volumes:
      # Configuration file attachment
      - ./config.toml:/etc/gorse/config.toml
    command: >
      -c /etc/gorse/config.toml 
      --log-path /var/log/gorse/master.log 
      --cache-path /var/lib/gorse/master_cache.data
    depends_on:
      - gorse_db
      - gorse_redis

  # --- Database (MySQL) ---
  gorse_db:
    image: mysql/mysql-server
    container_name: gorse_db
    restart: unless-stopped
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root_pass
      MYSQL_DATABASE: gorse
      MYSQL_USER: gorse
      MYSQL_PASSWORD: gorse_pass
    volumes:
      - gorse_db_data:/var/lib/mysql # Data save location

  # --- CACHE (Redis) ---
  gorse_redis:
    image: redis
    container_name: gorse_redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - gorse_redis_data:/data

volumes:
  gorse_db_data:
  gorse_redis_data:
  app_db_data: